<?php
$database = "if21_robin_ku";

function show_latest_public_foto() {
    $privacy = 3;
    $conn = new mysqli(
        $GLOBALS["server_host"],
        $GLOBALS["server_user_name"],
        $GLOBALS["server_password"],
        $GLOBALS["database"]
    );
    $conn->set_charset("utf8");
    $stmt = $conn->prepare(
        "SELECT filename, alttext FROM vpr_photos WHERE id = (SELECT MAX(id) FROM vpr_photos WHERE privacy = ? AND deleted IS NULL)"
    );
    echo $conn->error;
    $stmt->bind_param("i", $privacy);
    $stmt->bind_result($filename_from_db, $alttext_from_db);
    $stmt->execute();
    if ($stmt->fetch()) {
        // <img alt="alttekst" src="kataloog/filename">
        $photo_html = '<img src="' . $GLOBALS["photo_upload_normal_dir"] . $filename_from_db . '" alt="';
        if (empty($alttext_from_db)) {
            $photo_html .= "Üleslaetud foto";
        } else {
            $photo_html .= $alttext_from_db;
        }
        $photo_html .= '">' . "\n";
    } else {
        $photo_html = "<p>Kahjuks avalikke fotosid üles laetud pole!</p> \n";
    }
    $stmt->close();
    $conn->close();
    return $photo_html;
}

function read_public_photo_thumbs($privacy, $page, $limit) {
    $photo_html = null;
    $skip = ($page - 1) * $limit;
    $conn = new mysqli(
        $GLOBALS["server_host"],
        $GLOBALS["server_user_name"],
        $GLOBALS["server_password"],
        $GLOBALS["database"]
    );
    $conn->set_charset("utf8");
    /**
     * $stmt = $conn->prepare("
     *     SELECT filename, alttext FROM vpr_photos WHERE privacy >= ? AND deleted IS NULL"
     * );
     * $stmt = $conn->prepare("
     *     SELECT filename, alttext FROM vpr_photos WHERE privacy >= ? AND deleted IS NULL ORDER BY id DESC"
     * );
     */
    $stmt = $conn->prepare(
        "SELECT filename, alttext FROM vpr_photos WHERE privacy >= ? AND deleted IS NULL ORDER BY id DESC LIMIT ?, ?"
    );
    echo $conn->error;
    $stmt->bind_param("iii", $privacy, $skip, $limit);
    $stmt->bind_result($filename_from_db, $alttext_from_db);
    $stmt->execute();
    while ($stmt->fetch()) {
        /**
         * <div>
         * <img alt="alttekst" src="kataloog/filename">
         * ....
         * </div>
         */
        $photo_html .= '<div class="thumbgallery">' . "\n";
        $photo_html .= '<img src="' . $GLOBALS["photo_upload_thumb_dir"] . $filename_from_db . '" alt="';
        if (empty($alttext_from_db)) {
            $photo_html .= "Üleslaetud foto";
        } else {
            $photo_html .= $alttext_from_db;
        }
        $photo_html .= '" class="thumbs">' . "\n";
        $photo_html .= "</div> \n";
    }
    if (empty($photo_html)) {
        $photo_html = "<p>Kahjuks avalikke fotosid üles laetud pole!</p> \n";
    }
    $stmt->close();
    $conn->close();
    return $photo_html;
}

function count_public_photos($privacy) {
    $photo_count = 0;
    $conn = new mysqli(
        $GLOBALS["server_host"],
        $GLOBALS["server_user_name"],
        $GLOBALS["server_password"],
        $GLOBALS["database"]
    );
    $conn->set_charset("utf8");
    $stmt = $conn->prepare(
        "SELECT COUNT(id) FROM vpr_photos WHERE privacy >= ? AND deleted IS NULL"
    );
    echo $conn->error;
    $stmt->bind_param("i", $privacy);
    $stmt->bind_result($count_from_db);
    $stmt->execute();
    if ($stmt->fetch()) {
        $photo_count = $count_from_db;
    }
    $stmt->close();
    $conn->close();
    return $photo_count;
}

function read_own_photo_thumbs($page, $limit) {
    $photo_html = null;
    $skip = ($page - 1) * $limit;
    $conn = new mysqli(
        $GLOBALS["server_host"],
        $GLOBALS["server_user_name"],
        $GLOBALS["server_password"],
        $GLOBALS["database"]
    );
    $conn->set_charset("utf8");
    $stmt = $conn->prepare(
        "SELECT id, filename, alttext FROM vpr_photos WHERE userid = ? AND deleted IS NULL ORDER BY id DESC LIMIT ?, ?"
    );
    echo $conn->error;
    $stmt->bind_param("iii", $_SESSION["user_id"], $skip, $limit);
    $stmt->bind_result($id_from_db, $filename_from_db, $alttext_from_db);
    $stmt->execute();
    while ($stmt->fetch()) {
        /**
         * <div>
         * <a href="edit_own_photo.php?photo=x>
         * <img alt="alttekst" src="kataloog/filename">
         * ....
         * </a>
         * </div>
         */
        $photo_html .= '<div class="thumbgallery">' . "\n";
        $photo_html .= '<a href="edit_own_photo.php?page=' . $id_from_db . '">';
        $photo_html .= '<img src="' . $GLOBALS["photo_upload_thumb_dir"] . $filename_from_db . '" alt="';
        if (empty($alttext_from_db)) {
            $photo_html .= "Üleslaetud foto";
        } else {
            $photo_html .= $alttext_from_db;
        }
        $photo_html .= '" class="thumbs">' . "\n";
        $photo_html .= "</a>";
        $photo_html .= "</div> \n";
    }
    if (empty($photo_html)) {
        $photo_html = "<p>Kahjuks avalikke fotosid üles laetud pole!</p> \n";
    }
    $stmt->close();
    $conn->close();
    return $photo_html;
}

function count_own_photos() {
    $photo_count = 0;
    $conn = new mysqli(
        $GLOBALS["server_host"],
        $GLOBALS["server_user_name"],
        $GLOBALS["server_password"],
        $GLOBALS["database"]
    );
    $conn->set_charset("utf8");
    $stmt = $conn->prepare(
        "SELECT COUNT(id) FROM vpr_photos WHERE userid = ? AND deleted IS NULL"
    );
    echo $conn->error;
    $stmt->bind_param("i", $_SESSION["user_id"]);
    $stmt->bind_result($count_from_db);
    $stmt->execute();
    if ($stmt->fetch()) {
        $photo_count = $count_from_db;
    }
    $stmt->close();
    $conn->close();
    return $photo_count;
}
